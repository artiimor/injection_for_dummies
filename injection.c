#include <stdio.h>
#include <stdlib.h>

#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>
#include "sys/reg.h"
#include "sys/user.h"

#include "ptrace.h"

int main(int argc, char *argv[])
{
       pid_t traced_process;
       struct user_regs_struct oldregs, regs;
       long ins;
       int check_SO;

       char insertcode[] = "\x48\x89\xe5\x48\x83\xec\x20\xc6\x45\xf0\x30\xc6\x45\xf1\x20\xc6\x45\xf2\x0\xc6\x45\xf3\xa\xc6\x45\xf4\x0\xbe\x3\x0\x0\x0\x48\x8d\x7d\xf0\xe8\x2d\x0\x0\x0\x8a\x45\xf0\xfe\xc0\x3c\x3a\x7c\x15\xb8\x30\x0\x0\x0\x50\x48\x8d\x7d\xf3\xbe\x1\x0\x0\x0\xe8\x10\x0\x0\x0\x58\x88\x45\xf0\xbf\x1\x0\x0\x0\xe8\x15\x0\x0\x0\xeb\xc5\x48\x89\xf2\x48\x89\xfe\xbf\x1\x0\x0\x0\xb8\x1\x0\x0\x0\xf\x5\xc3\x55\x48\x89\xe5\x48\x83\xec\x20\x48\xc7\x45\xe0\x0\x0\x0\x0\x48\xc7\x45\xe8\x0\x0\x0\x0\x89\x7d\xe0\x48\x8d\x7d\xe0\xbe\x0\x0\x0\x0\xb8\x23\x0\x0\x0\xf\x5\x48\x89\xec\x5d\xc3\xdd\x1b\x0\x0\x0\x0\x0\x50\xdd\x1b\x0\x0\x0\x0\x0\x50\xdd\x1b\x0\x0\x0\x0\x0\x1c\x0\x0\x0\x0\x0\x0\x0\x1c\x0\x0\x0\x0\x0\x0\x0\x10\x0\x0\x0\x0\x0\x0\x0\x1\x0\x0\x0\x5\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x54\xb7\x6\xd8\x33\x7f\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x35\x26\xd8\x33\x7f\x0\x0\x2\x0\x0\x0\x0\x0\x0\x0\x5f\x4f\x6\xd8\x33\x7f\x0\x0\xf0\x29\x28\xd8\x33\x7f\x0\x0\x0\x4\x0\x0\x0\x0\x0\x0\x20\x76\x3e\x0\x40\x0\x0\x0\x7\x0\x0\x0\x0\x0\x0\x0\x10\x4\x0\x0\x0\x0\x0\x0\x8\xd2\xb8\xf2\x9c\x55\x0\x0\x30\x4\x0\x0\x0\x0\x0\x0\xb0\xff\xff\xff\xff\xff\xff\xff\x10\x0\x0\x0\x0\x0\x0\x0\x41\x0\x0\x0\x40\x0\x0\x0\x2\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x7c\x0\x0\x0\x77\x0\x0\x0\x6e\x0\x0\x0\x5d\x0\x0\x0\xd1\xb6\x84\xd7\x33\x7f\x0\x0\x1\x80\xad\xfb\x33\x7f\x0\x0\x0\x4\x0\x0\x0\x0\x0\x0\xb0\xff\xff\xff\xff\xff\xff\xff\xa\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\xa0\xd2\xb8\xf2\x9c\x55\x0\x0\xff\x3\x0\x0\x0\x0\x0\x0\xfc\x10\x86\xd7\x33\x7f\x0\x0\xff\xff\xff\xff\xff\xff\xff\xff\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x4\x0\x0\x0\x0\x0\x0\x0\x4\x0\x0\x0\x0\x0\x0\xaa\x81\x84\xd7\x33\x7f\x0\x0\x4\x0\x0\x0\x0\x0\x0\x0\x87\xc0\x0\x0\x0\x0\x0\x0\x1\x0\x0\x0\x0\x0\x0\x0\x24\x81\x0\x0\xe8\x3\x0\x0\xe8\x3\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\xb\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x2\x0\x0\x0\x7\x0\x0\x0\x0\x0\x0\x0\x20\x0\x0\x0\x0\x0\x0\x0\x10\xd0\xb8\xf2\x9c\x55\x0\x0\x40\x0\x0\x0\x0\x0\x0\x0\xb0\xff\xff\xff\xff\xff\xff\xff\x0\x0\x0\x0\x0\x0\x0\x0\x2\x0\x0\x0\x30\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x7c\x0\x0\x0\x77\x0\x0\x0\x6e\x0\x0\x0\x5b\x0\x0\x0\xa0\x22\xbb\xd7\x33\x7f\x0\x0\xa\x0\x0\x0\x0\x0\x0\x0\xb\x0\x0\x0\x0\x0\x0\x0\xb0\xff\xff\xff\xff\xff\xff\xff\xa0\xd2\xb8\xf2\x9c\x55\x0\x0\x68\xd\x0\x0\x0\x0\x0\x0\x48\x71\x85\xd7\x33\x7f\x0\x0\xa0\xd2\xb8\xf2\x9c\x55\x0\x0\xa0\x22\xbb\xd7\x33\x7f\x0\x0\xa\x0\x0\x0\x0\x0\x0\x0\xde\xd9\xb8\xf2\x9c\x55\x0\x0\xa0\xd2\xb8\xf2\x9c\x55\x0\x0\xf2\x83\x85\xd7\x33\x7f\x0\x0\x99\xcd\xbd\x4\xfe\x7f\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x50\xcd\xbd\x4\xfe\x7f\x0\x0\x62\x9e\x84\xd7\x33\x7f\x0\x0\x50\xcd\xbd\x4\xfe\x7f\x0\x0\x7e\xe\xc8\xf0\x1\x0\x0\x0\xf4\xd6\xb8\xf2\x9c\x55\x0\x0\xa0\xd2\xb8\xf2\x9c\x55\x0\x0\x50\xcd\xbd\x4\xfe\x7f\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\xc0\xd2\xbd\x4\xfe\x7f\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\xcd\x8b\x84\xd7\x33\x7f\x0\x0\x0\x0\x0\x0\x0\x0\x0\x0\x60\xd1\xbd\x4\xfe\x7f\x0\x0\x10\xff\xc7\xf0\x9c\x55\x0\x0\x91\x11\xc8\xf0\x9c\x55\x0\x0\x60\xad\x85\xd7\x33\x7f\x0\x0\x80\xd2\xb8\xf2\x9c\x55\x0\x0\x15\x0\x0\x0\x0\x0\x0\x0\x14\x0\x0\x0\x12\x0\x0\x0\xd0\xd4\xb8\xf2\x9c\x55\x0\x0\xd4\xd4\xb8\xf2\x9c\x55\x0\x0\x14\xd7\xb8\xf2\x9c\x55\x0\x0\xa0\xd2\xb8\xf2\x9c\x55\x0\x0\x66\x66\x66\x66\x66\x66\x66\x66\x66\x66\x36\x30\x30\x30\x30\x30\x2d\x66\x66\x66\x66\x66\x66\x66\x66\x66\x66\x36\x30\x31\x30\x30\x30\x0\x72\x2d\x78\x70\x0\x30\x30\x30\x30\x30\x30\x30\x30\x0";
       char aux[] = "asd";
       int len = sizeof(insertcode);
       char backup[len];
       char pruebesita[len];
       long addr;

       if (argc != 2)
       {
              printf("Usage: %s <pid to be traced>\n",
                     argv[0]);
              exit(1);
       }
       traced_process = atoi(argv[1]);
       printf("PID: %d\n", traced_process);

       /*******************************************/
       /**************ATTATCH PROCESS**************/
       /*******************************************/
       if (ptrace(PTRACE_ATTACH, traced_process,
                  NULL, NULL) == -1)
       {
              printf("[ERROR] something went wrong when attatching\n");
              return -1;
       }
       wait(NULL);

       /*******************************************/
       /**************KIDNAP REGISTERS*************/
       /*******************************************/
       if (ptrace(PTRACE_GETREGS, traced_process,
                  NULL, &regs) == -1)
       {
              printf("[ERROR] something went wrong trying to get the registers\n");
              return -1;
       }

       addr = freespaceaddr(traced_process);

       /*******************************************/
       /***************Little backup***************/
       /*******************************************/
       ptrace_readmem(traced_process, addr, backup, len);

       printf("DATA BEFORE INSERT (ONLY FIRST WORD): ");
       printf("%lx\n", ptrace(PTRACE_PEEKDATA, traced_process,
                              addr, NULL));

       printf("RIP at the begining: %llx\n\n", regs.rip);

       /*******************************************/
       /*************Some comprobations************/
       /*******************************************/

       printf("Checking if i am inside a SO\n");

       while (mommy_am_i_inside_a_SO(traced_process))
       {
              if (ptrace(PTRACE_SINGLESTEP, traced_process, NULL, NULL) == -1)
                     return -1;
       }

       /*******************************************/
       /*************Inject evil stuff*************/
       /*******************************************/

       ptrace_writemem(traced_process, addr, insertcode, len);

       printf("DATA AFTER INSERTION:\n");
       /*printf("%lx\n", ptrace(PTRACE_PEEKDATA, traced_process,
                              addr, NULL));*/
       print_memory_map(traced_process);
       printf("\n\n\n");

       /*******************************************/
       /***********another little backup***********/
       /*******************************************/
       memcpy(&oldregs, &regs, sizeof(regs));

       /*look the instruction pointer*/
       printf("backup RIP: %llx\n", oldregs.rip);

       /*instruction pointer where we injected the code*/
       regs.rip = addr;

       printf("RIP with our code position :) %llx\n\n\n", regs.rip);

       /*new regs with instruction pointer in addr*/
       ptrace(PTRACE_SETREGS, traced_process,
              NULL, &regs);

       /*******************************************/
       /************execute our shit***************/
       /*******************************************/
       ptrace(PTRACE_CONT, traced_process,
              NULL, NULL);
       wait(NULL);

       if (ptrace(PTRACE_CONT, traced_process, NULL, NULL) == -1)
              return -1;
       wait(NULL);
       if (ptrace(PTRACE_CONT, traced_process, NULL, NULL) == -1)
              return -1;
       wait(NULL);
       if (ptrace(PTRACE_CONT, traced_process, NULL, NULL) == -1)
              return -1;
       wait(NULL);
       if (ptrace(PTRACE_CONT, traced_process, NULL, NULL) == -1)
              return -1;
       wait(NULL);
       if (ptrace(PTRACE_CONT, traced_process, NULL, NULL) == -1)
              return -1;
       wait(NULL);

       printf("The process stopped, Putting back "
              "the original instructions\n");

       /*******************************************/
       /*****Restore the original instructions*****/
       /*******************************************/
       ptrace_writemem(traced_process, addr, backup, len);

       printf("DATA AFTER RESTORING:\n");
       /*printf("%lx\n", ptrace(PTRACE_PEEKDATA, traced_process,
                              addr, NULL));*/

       print_memory_map(traced_process);
       printf("\n\n\n");

       /*******************************************/
       /*********Restore original registers********/
       /*******************************************/
       ptrace(PTRACE_SETREGS, traced_process,
              NULL, &oldregs);

       /*******************************************/
       /************Just for comprobation**********/
       /*******************************************/

       if (ptrace(PTRACE_GETREGS, traced_process,
                  NULL, &regs) == -1)
       {
              printf("[ERROR] something went wrong trying to get the registers\n");
              return -1;
       }

       printf("RIP restored: %llx\n", regs.rip);

       /*******************************************/
       /*************Detach and end it*************/
       /*******************************************/
       ptrace(PTRACE_DETACH, traced_process,
              NULL, NULL);

       printf("\n\nLetting it continue with "
              "original flow\n");

       return 0;
}
